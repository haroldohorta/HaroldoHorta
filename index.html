<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Haroldo Horta | 50 A√±os de Memoria Viva</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0f0f0f; font-family: 'Courier New', monospace; color: #ccc; }
        #map { height: 100%; width: 100%; background: #0f0f0f; }
        .leaflet-popup-content-wrapper { background: #1a1a1a; color: #eee; border: 1px solid #ff9f1c; border-radius: 0; padding: 0; }
        .leaflet-popup-tip { background: #1a1a1a; border-top: 1px solid #ff9f1c; }
        .popup-img { width: 100%; height: 140px; object-fit: cover; border-bottom: 1px solid #ff9f1c; display: block; background: #000; }
        .btn-portafolio { width: 100%; background: #222; color: #ff9f1c; padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 11px; text-decoration: none; display: block; text-align: center; box-sizing: border-box; transition: 0.3s; }
        .btn-portafolio:hover { background: #ff9f1c; color: #000; }
        
        .marker-cluster div { background-color: #000 !important; border: 2px solid #fff; font-family: 'Courier New', monospace; font-weight: bold; }
        
        /* --- PANEL T√ÅCTICO DE BOTONES --- */
        #controls { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; max-width: 700px;}
        
        button.btn-filter {
            font-family: 'Courier New', monospace;
            font-weight: 900;
            font-size: 12px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        /* Colores de Alto Contraste */
        .btn-todo { background: #ffffff; color: #000000; border: 2px solid #ffffff; }
        .btn-patrimonio { background: #FFD700; color: #000000; border: 2px solid #FFD700; } /* Dorado Fuerte */
        .btn-aereo { background: #005CE6; color: #ffffff; border: 2px solid #005CE6; } /* Azul Profundo */
        .btn-nomad { background: #FF1A1A; color: #000000; border: 2px solid #FF1A1A; } /* Rojo Puro */
        .btn-narrativa { background: #9900FF; color: #ffffff; border: 2px solid #9900FF; } /* Morado Ne√≥n */
        
        /* Bot√≥n Sat√©lite Especial */
        .btn-sat { background: #111; color: #00ffcc; border: 2px solid #00ffcc; margin-right: 15px;}

        button.inactive {
            background: #222 !important;
            color: #555 !important;
            border-color: #333 !important;
        }

        button:hover:not(.inactive) { filter: brightness(1.2); transform: scale(1.02); }

        /* --- LEYENDA --- */
        .legend { position: absolute; bottom: 30px; left: 30px; background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px; z-index: 1000; font-size: 12px; font-weight: bold; border-radius: 4px; color: #fff;}
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; margin-right: 8px; vertical-align: middle;} 
        
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f0f0f; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #loading .spinner { font-size: 50px; margin-bottom: 20px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="loading"><div class="spinner">üì∑</div><div style="color:#FFD700; font-weight:bold;">CARGANDO ATLAS...</div></div>
<div id="map"></div>

<div id="controls">
    <button id="btn-sat" class="btn-filter btn-sat" onclick="toggleSatelite()">üõ∞Ô∏è SAT√âLITE</button>
    <button id="btn-todo" class="btn-filter btn-todo" onclick="verTodo()">üåç VER TODO</button>
    <button id="btn-patrimonio" class="btn-filter btn-patrimonio" onclick="toggleCapa('patrimonio')">üèõÔ∏è PATRIMONIO (pub_)</button>
    <button id="btn-aereo" class="btn-filter btn-aereo" onclick="toggleCapa('aereo')">‚úàÔ∏è A√âREO (fly_)</button>
    <button id="btn-nomad" class="btn-filter btn-nomad" onclick="toggleCapa('nomad')">üéí N√ìMADE (nomad_)</button>
    <button id="btn-narrativa" class="btn-filter btn-narrativa" onclick="toggleCapa('narrativa')">üéôÔ∏è NARRATIVA</button>
</div>

<div class="legend">
    <div style="margin-bottom: 5px;"><span class="dot" style="background:#FFD700;"></span> PATRIMONIO</div>
    <div style="margin-bottom: 5px;"><span class="dot" style="background:#005CE6;"></span> A√âREO</div>
    <div style="margin-bottom: 5px;"><span class="dot" style="background:#FF1A1A;"></span> N√ìMADE</div>
    <div><span class="dot" style="background:#9900FF;"></span> NARRATIVA</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    // Configuraci√≥n de las dos capas (Oscura y Sat√©lite) con l√≠mite de zoom (maxZoom: 16)
    const capaOscura = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
        attribution: 'SUR DAO | Haroldo Horta',
        maxZoom: 16 
    });
    const capaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
        attribution: 'Tiles &copy; Esri',
        maxZoom: 16 
    });

    // Iniciar mapa con l√≠mite de altitud para evitar el "vac√≠o gris"
    const map = L.map('map', {
        center: [-22.9, -68.2],
        zoom: 10,
        maxZoom: 16, // ¬°El Paraca√≠das!
        layers: [capaOscura]
    });
    
    const markers = L.markerClusterGroup({ spiderfyOnMaxZoom: true, zoomToBoundsOnClick: true });
    
    function getSpiralOffset(lat, lon, index, totalPerZone = 20) {
        const angle = (index / totalPerZone) * Math.PI * 4;
        const r = 0.0008 * (1 + 0.5 * Math.sin(angle));
        return [lat + Math.cos(angle) * r, lon + Math.sin(angle) * r];
    }
    
    let allData = [];
    let filtrosActivos = { patrimonio: true, aereo: true, nomad: true, narrativa: true };
    let modoSatelite = false;

    // Funci√≥n del bot√≥n sat√©lite
    window.toggleSatelite = () => {
        modoSatelite = !modoSatelite;
        const btnSat = document.getElementById('btn-sat');
        
        if (modoSatelite) {
            map.removeLayer(capaOscura);
            map.addLayer(capaSatelite);
            btnSat.innerHTML = 'üó∫Ô∏è MODO RADAR';
            btnSat.style.color = '#FFD700';
            btnSat.style.borderColor = '#FFD700';
        } else {
            map.removeLayer(capaSatelite);
            map.addLayer(capaOscura);
            btnSat.innerHTML = 'üõ∞Ô∏è SAT√âLITE';
            btnSat.style.color = '#00ffcc';
            btnSat.style.borderColor = '#00ffcc';
        }
    };

    fetch('data/puntos_mapa.json').then(res => res.json()).then(data => {
        document.getElementById('loading').style.display = 'none';
        allData = data;
        renderizarMapa();
    });

    function renderizarMapa() {
        markers.clearLayers();
        let indexSpiral = 0;

        allData.forEach((p, i) => {
            if (!p.lat || !p.lon) return;

            let tipo = 'patrimonio'; 
            let capa = p.capa || '';
            let id = p.id || '';

            if (capa.includes('Narrativa')) tipo = 'narrativa';
            else if (capa.includes('A√©reo') || id.includes('fly_')) tipo = 'aereo';
            else if (capa.includes('Nomad') || id.includes('nomad_')) tipo = 'nomad';
            else tipo = 'patrimonio';

            // Colores puros de alto contraste
            let mColor = "#FFD700"; 
            if (tipo === 'narrativa') mColor = "#9900FF";
            if (tipo === 'aereo') mColor = "#005CE6";
            if (tipo === 'nomad') mColor = "#FF1A1A";

            if (filtrosActivos[tipo]) {
                let [offsetLat, offsetLon] = getSpiralOffset(p.lat, p.lon, indexSpiral++);
                
                // Puntos con borde BLANCO grueso (Alto contraste)
                const marker = L.circleMarker([offsetLat, offsetLon], { 
                    radius: 9, fillColor: mColor, color: "#ffffff", weight: 2, fillOpacity: 1 
                });
                
                marker.bindPopup(`<div style="min-width:180px;text-align:center;">
                    <div style="font-size:10px;color:${mColor};font-weight:bold;text-transform:uppercase;">${tipo}</div>
                    <h3 style="color:#fff; margin: 5px 0;">${(p.zona||'ZONA').toUpperCase()}</h3>
                    <img src="${p.thumb}" class="popup-img" onerror="this.style.display='none'">
                    <a href="galeria.html?zona=${p.zona}" class="btn-portafolio">ABRIR EXPEDIENTE üìÇ</a>
                </div>`);
                
                markers.addLayer(marker);
            }
        });
        map.addLayer(markers);
    }

    window.toggleCapa = (capa) => {
        filtrosActivos[capa] = !filtrosActivos[capa]; 
        
        const btn = document.getElementById(`btn-${capa}`);
        if(filtrosActivos[capa]) {
            btn.classList.remove('inactive');
        } else {
            btn.classList.add('inactive');
        }
        
        document.getElementById('btn-todo').classList.add('inactive');
        renderizarMapa();
    };

    window.verTodo = () => {
        filtrosActivos = { patrimonio: true, aereo: true, nomad: true, narrativa: true };
        
        ['patrimonio', 'aereo', 'nomad', 'narrativa', 'todo'].forEach(c => {
            document.getElementById(`btn-${c}`).classList.remove('inactive');
        });
        
        renderizarMapa();
        map.fitBounds(markers.getBounds(), {padding: [50,50]});
    };
</script>
</body>
</html>
