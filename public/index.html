<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas | Haroldo Horta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- EST√âTICA GENERAL (Dark Mode) --- */
        body, html { margin: 0; padding: 0; height: 100%; background: #0e0e0e; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        
        #map { height: 100%; width: 100%; background: #0e0e0e; }

        /* Personalizaci√≥n de los Popups (Ventanas de info) */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 20, 20, 0.95);
            color: #eee;
            border: 1px solid #ff9f1c; /* Borde Naranja Haroldo */
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        .leaflet-popup-tip {
            background: rgba(20, 20, 20, 0.95);
            border-top: 1px solid #ff9f1c;
        }
        .leaflet-popup-content {
            margin: 12px;
            line-height: 1.4;
        }

        /* Im√°genes dentro del popup */
        .popup-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border: 1px solid #444;
            margin: 8px 0;
            display: block;
            background: #000;
        }

        /* Bot√≥n de Acci√≥n */
        .btn-expediente {
            display: block;
            width: 100%;
            background: transparent;
            color: #ff9f1c;
            border: 1px solid #ff9f1c;
            padding: 8px 0;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .btn-expediente:hover {
            background: #ff9f1c;
            color: #000;
        }

        /* Leyenda (Abajo a la derecha) */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #444;
            z-index: 1000;
            color: #ccc;
            font-size: 12px;
            border-radius: 4px;
        }
        .dot { height: 10px; width: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="legend">
        <div style="margin-bottom:5px;"><span class="dot" style="background:#ff4d4d;"></span> Cr√≥nica & Etnograf√≠a</div>
        <div style="margin-bottom:5px;"><span class="dot" style="background:#4d94ff;"></span> Registro A√©reo</div>
        <div style="margin-bottom:5px;"><span class="dot" style="background:#ffdb4d;"></span> Bit√°cora N√≥mada</div>
        <div><span class="dot" style="background:#ffffff;"></span> Archivo Naval/Otro</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Configuraci√≥n Inicial
        // Centrado en Sudam√©rica por defecto, Zoom 3
        const map = L.map('map').setView([-28, -68], 4);

        // 2. Mapa Base (CartoDB Dark Matter - El estilo "Cuarto Oscuro")
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; Haroldo Horta | SUR DAO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // 3. Sistema de Colores (Coincide con unificar_atlas.py)
        const getColor = (capa) => {
            if (!capa) return "#ffffff";
            if (capa.includes("Cr√≥nica") || capa.includes("Etnograf√≠a")) return "#ff4d4d"; // Rojo Prensa
            if (capa.includes("A√©reo") || capa.includes("fly")) return "#4d94ff";        // Azul Cielo
            if (capa.includes("N√≥mada") || capa.includes("nomad")) return "#ffdb4d";     // Amarillo Desierto
            if (capa.includes("Naval")) return "#00b894";                                // Verde Mar
            return "#ffffff";
        };

        // 4. Cargar los Datos (Leyendo data/puntos_mapa.json)
        fetch('data/puntos_mapa.json')
            .then(response => response.json())
            .then(data => {
                console.log("üìç Puntos cargados del Atlas:", data.length);

                data.forEach(punto => {
                    // Validar coordenadas
                    if (!punto.lat || !punto.lon) return;

                    // Crear el marcador circular
                    const circle = L.circleMarker([punto.lat, punto.lon], {
                        color: "#000",           // Borde negro fino
                        weight: 1,
                        fillColor: getColor(punto.capa),
                        fillOpacity: 0.8,
                        radius: 7
                    }).addTo(map);

                    // Preparar contenido del Popup
                    // (Si no hay foto, ocultamos la etiqueta img)
                    const imgTag = punto.thumb 
                        ? `<img src="${punto.thumb}" class="popup-img" onerror="this.style.display='none'">` 
                        : '';

                    const popupContent = `
                        <div style="min-width: 200px; text-align: center;">
                            <div style="font-size: 9px; color: #888; text-transform: uppercase; margin-bottom: 5px;">
                                ${punto.capa || 'ARCHIVO GENERAL'}
                            </div>
                            <h3 style="margin: 0; font-size: 16px; color: #fff;">${punto.zona.toUpperCase()}</h3>
                            
                            ${imgTag}
                            
                            <p style="font-size: 11px; color: #aaa; margin: 8px 0;">
                                ${punto.descripcion || 'Registro documental georreferenciado.'}
                            </p>

                            <a href="galeria.html?zona=${punto.zona}" class="btn-expediente">
                                üìÇ Abrir Expediente
                            </a>
                        </div>
                    `;

                    circle.bindPopup(popupContent);
                });
            })
            .catch(error => {
                console.error("‚ùå Error cargando el JSON:", error);
                alert("Error: No se pudo cargar 'data/puntos_mapa.json'.\n\nSi est√°s abriendo esto directo del archivo, usa 'python -m http.server' por seguridad del navegador.");
            });
    </script>
</body>
</html>